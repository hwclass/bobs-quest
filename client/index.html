<html>
	<head>
		<style>
      #map {
        width: 500px;
        height: 400px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.5.0/lodash.min.js"></script>
	</head>
	<body>
		<div id="wrapper">
			<div id="map"></div>
			<script src="https://maps.googleapis.com/maps/api/js?callback=initMap" defer></script>
			<ul id="foundersList"></ul>
		</div>
		<script>
			var founders = null,
					cachedFounders =[] ,
					foundersList = document.getElementById('foundersList'),
					source = new EventSource('/founders');
			
			source.addEventListener('message', function(e) {
			  console.log((new Date()).toLocaleTimeString() + ' : message fetched.');
			  founders = JSON.parse(e.data);
			  var state = document.readyState;
	      if(state === 'interactive' || state === 'complete') {
          if (!_.isEqual(cachedFounders.sort(), founders.sort())) {
          	cachedFounders = founders;
          	injectFoundersIntoDom(founders, function (founders) {
          		updateMap(founders);
          	});
          }
	      } else { setTimeout(arguments.callee, 200); }
			}, false);

			source.addEventListener('open', function(e) {
			  console.log((new Date()).toLocaleTimeString() + ' : connection is now arrived.');
			}, false);

			source.addEventListener('error', function(e) {
			  if (e.readyState == EventSource.CLOSED) {
			    console.log((new Date()).toLocaleTimeString() + ' : connection is now closed.');
			  }
			}, false);

			function injectFoundersIntoDom (founders, callback) {
				foundersList.innerHTML = '';
				for (var foundersIndex = 0, len = founders.length; foundersIndex < len; foundersIndex++) {
					foundersList.innerHTML += '<li>' + founders[foundersIndex]['Founder'] + ' ' + founders[foundersIndex]['City'] + founders[foundersIndex]['Country'] + ' ' + founders[foundersIndex]['Postal Code'] + ' ' + founders[foundersIndex]['City'] + ' ' + founders[foundersIndex]['Street'] + ' ' + founders[foundersIndex]['Home Page'] + ' ' + founders[foundersIndex]['Garage Latitude'] + ' ' + founders[foundersIndex]['Garage Longitude'] + '</li>';
				}
				callback(founders);
			}

			function initMap (latitude, longitude) {
				var mapDiv = document.getElementById('map');
		    var map = new google.maps.Map(mapDiv, {
		      center: {lat: 44.540, lng: -78.546},
		      zoom: 8
		    });
			}

			function updateMap (founders) {
				var mapDiv = document.getElementById('map');
		    var map = new google.maps.Map(mapDiv, {
		      center: {lat: founders[0]['Garage Latitude'], lng: founders[0]['Garage Longitude']},
		      zoom: 8
		    });
		    createMarkers(map, google, founders);
			}

			function createMarkers (map, google, founders) {
				for (var foundersIndex = 0, len = founders.length; foundersIndex < len; foundersIndex++) {
					var marker = new google.maps.Marker({
		        position: {lat: founders[foundersIndex]['Garage Latitude'], lng: founders[foundersIndex]['Garage Longitude']},
		        map: map,
		        title: 'Hello World!'
		      });
				}
			}

		</script>
	</body>
</html>