<html>
	<head>
		<style>
      #map {
        width: 500px;
        height: 400px;
      }
      .geo-item {
      	cursor : pointer;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.5.0/lodash.min.js"></script>
    <script src="https://cdn.rawgit.com/hwclass/booklet/master/dist/booklet-1.2.1.min.js" defer></script>
	</head>
	<body>
		<div id="wrapper">
			<div id="map"></div>
			<script src="https://maps.googleapis.com/maps/api/js?callback=initMap" defer></script>
			<ul id="foundersList"></ul>
		</div>
		<script>
			var founders = null,
					cachedFounders =[] ,
					foundersList = document.getElementById('foundersList'),
					source = new EventSource('/founders');
			
			source.addEventListener('message', function(e) {
			  console.log((new Date()).toLocaleTimeString() + ' : message fetched.');
			  founders = JSON.parse(e.data);
			  var state = document.readyState;
	      if(state === 'interactive' || state === 'complete') {
          if (!_.isEqual(cachedFounders.sort(), founders.sort())) {
          	cachedFounders = founders;
          	injectFoundersIntoDom(founders, function (founders) {
          		updateMap(founders);
          	});
          }
	      } else { setTimeout(arguments.callee, 200); }
			}, false);

			source.addEventListener('open', function(e) {
			  console.log((new Date()).toLocaleTimeString() + ' : connection is now arrived.');
			}, false);

			source.addEventListener('error', function(e) {
			  if (e.readyState == EventSource.CLOSED) {
			    console.log((new Date()).toLocaleTimeString() + ' : connection is now closed.');
			  }
			}, false);

			function injectFoundersIntoDom (founders, callback) {
				foundersList.innerHTML = '';
				for (var foundersIndex = 0, len = founders.length; foundersIndex < len; foundersIndex++) {
					foundersList.innerHTML += '<li class="geo-item" data-lat="'+founders[foundersIndex]['Garage Latitude']+'" data-long="'+founders[foundersIndex]['Garage Longitude']+'">' + founders[foundersIndex]['Founder'] + ' ' + founders[foundersIndex]['City'] + founders[foundersIndex]['Country'] + ' ' + founders[foundersIndex]['Postal Code'] + ' ' + founders[foundersIndex]['City'] + ' ' + founders[foundersIndex]['Street'] + ' ' + founders[foundersIndex]['Home Page'] + ' ' + founders[foundersIndex]['Garage Latitude'] + ' ' + founders[foundersIndex]['Garage Longitude'] + '</li>';
				}
				callback(founders);
			}

			function initMap (latitude, longitude) {
				var mapDiv = document.getElementById('map');
		    var map = new google.maps.Map(mapDiv, {
		      center: {lat: 44.540, lng: -78.546},
		      zoom: 8
		    });
			}

			function updateMap (founders, selectedLat, selectedLong) {
				var mapDiv = document.getElementById('map');
		    var map = new google.maps.Map(mapDiv, {
		      center: {lat: (!_.isUndefined(selectedLat)?parseFloat(selectedLat):founders[0]['Garage Latitude']), lng: (!_.isUndefined(selectedLong)?parseFloat(selectedLong):founders[0]['Garage Longitude'])
		    	},
		      zoom: 8
		    });
		    if (_.isUndefined(selectedLat) && _.isUndefined(selectedLong)) {
		    	createMarkers(map, google, founders);
		    } else {
  				var marker = new google.maps.Marker({
  	        position: {lat: parseFloat(selectedLat), lng: parseFloat(selectedLong)},
  	        map: map
  	      });
		    }
			}

			function createMarkers (map, google, founders) {
				for (var foundersIndex = 0, len = founders.length; foundersIndex < len; foundersIndex++) {
					var marker = new google.maps.Marker({
		        position: {lat: founders[foundersIndex]['Garage Latitude'], lng: founders[foundersIndex]['Garage Longitude']},
		        map: map
		      });
				}
			}

			function locateOnMarker (lat, long) {
				updateMap(founders, lat, long);
			}

			function bindEvents () {
				var founderListItems = document.getElementsByClassName('geo-item');
				for (var founderListItemsIndex = 0, len = founderListItems.length; founderListItemsIndex < len; founderListItemsIndex++) {
					founderListItems[founderListItemsIndex].addEventListener('click', function (evt) {
						var lat = evt.target.attributes['data-lat'].nodeValue,
								long = evt.target.attributes['data-long'].nodeValue;
						locateOnMarker(lat, long);	
					}, false);
				}
			}

			window.onload = function () {
				bindEvents();
			}

		</script>
	</body>
</html>